<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                display: flex;
                height: 100vh;
            }
            input {
                width: 100%;
            }
            .outline {
                margin: 14px;
                padding: 14px;
                border: solid grey 2px;
            }
            #gui, #log { width: 50vw; }
            #log {
                font-family: Consolas, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New;
                color: white;
                background-color: black;
                padding: 14px;
                overflow-y: auto;
            }
        </style>
        <title>AD Sync for Databricks</title>
    </head>
    <body>
        <div id="gui">
            <button id="login">Login</button>
            <div class="outline">
                Databricks: <a href="#" target="_blank" id="databricks-domain-name"></a>
                <br /><br />
                <button id="get-scim-users">Get Databricks Users via SCIM</button>
            </div>
            <div id="post-databricks-gallery-app" class="outline">
                <label>Databricks SCIM ID: </label><input type="text" id="databricks-scim-id" value="9c9818d2-2900-49e8-8ba4-22688be7c675" />
                <br /><br />
                <label>Gallery App Name: </label><input type="text" id="gallery-app-name" />
                <br /><br />
                <button>Create Databricks Gallery App</button>
            </div>
            <div id="get-aad-group" class="outline">
                <label>Access Token: </label><input type="text" id="access-token" />
                <br /><br />
                <label>Search Display Name: </label><input type="text" id="filter-display-name" value="Databricks-SCIM" />
                <br /><br />
                <button>Get AAD Groups</button>
            </div>
        </div>
        <div id="log"></div>
    </body>
    <script>
        const logElement = document.getElementById('log');
        function addToLog(content) {
            const childElement = document.createElement('div')
            childElement.innerHTML = content;
            logElement.appendChild(childElement)
        }

        // Log: whether user is logged in
        const hasAuthCode = document.location.search.split('&').some(param => param.includes('code='));
        addToLog(hasAuthCode ? 'Logged in...' : 'Not logged in...');

        // Login Button
        const loginElement = document.querySelector('button#login');
        loginElement.onclick = () => window.location.href = document.location.origin + '/login';

        // Display Databricks Workspace
        const databricksDomainName = 'https://adb-1514491097879978.18.azuredatabricks.net'
        const databricksDomainNameElement = document.querySelector('a#databricks-domain-name');
        databricksDomainNameElement.innerHTML = databricksDomainName;
        databricksDomainNameElement.href = databricksDomainName;

        // Get Databricks Workspace Users Button
        const getScimUsersElement = document.querySelector('button#get-scim-users');
        getScimUsersElement.onclick = async () => {
            addToLog(`<br />Fetching databricks workspace users from ${databricksDomainName}...`);
            try {
                const databricksUsers = await fetch(`${document.location.origin}/databricksUsers?databricksDomainName=${databricksDomainName}`)
                    .then((res) => {
                        if (res.status !== 200) {
                            throw new Error('Unable to fetch databricks workspace users');
                        }
                        return res.json();
                    });
                // Log: Databricks workspace users
                databricksUsers.Resources.forEach(({ active, displayName, userName, entitlements, groups }) => {
                    const formattedPermissions = entitlements.map(({ value }) => value).join(', ');
                    const formattedGroups = groups.map(({ display }) => display).join(', ');
                    userInfo = `<br />${displayName} (${userName})<br />Status: ${active ? 'active' : 'inactive'}<br />Permissions: ${formattedPermissions}<br />Groups: ${formattedGroups}`;
                    addToLog(userInfo);
                });
            } catch (err) {
                console.error(err);
                addToLog('<br />Error while fetching databricks workspace users...');
            }
        };

        function validateInputs(inputs) {
            inputs.reduce((time, { value, message }) => {
                if (!value) {
                    setTimeout(() => addToLog(message), time);
                    return time + 800;
                }
                return time;
            }, 800);
        }

        // Get code from URL parameter
        function getCodeFromUrlParam() {
            const codeParam = document.location.search.split('&').filter(param => param.includes('code='))[0];
            validateInputs([{ value: codeParam, message: '<br />Unable to complete request. Login required...' }]);
            if (codeParam) {
                return codeParam.split('=')[1];
            }
        }
 
        // Post Databricks Gallery App
        const postDatabricksGalleryAppElement = document.querySelector('#post-databricks-gallery-app button');
        postDatabricksGalleryAppElement.onclick = async () => {
            addToLog('<br/>Creating databricks gallery app...')
            // Get login code for auth token
            const codeValue = getCodeFromUrlParam();
            if (!codeValue) return;
            // Get data required to create Databricks Gallery App
            const databricksScimId = document.querySelector('#post-databricks-gallery-app input#databricks-scim-id').value;
            const galleryAppName = document.querySelector('#post-databricks-gallery-app input#gallery-app-name').value;

            if (!databricksScimId || !galleryAppName) {
                return validateInputs([
                    { value: databricksScimId, message: '<br/>Invalid databricks scim id...'},
                    { value: galleryAppName, message: '<br/>Invalid gallery app name...'},
                ]);
            }
            const response = await fetch(`${document.location.origin}/databricksGalleryApp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: codeValue, databricksScimId, galleryAppName }),
            });
            response.json().then((body) => {
                if (response.status === 201) {
                    const accessTokenElement = document.querySelector('#get-aad-group input#access-token');
                    accessTokenElement.value = body.access_token;
                }
                return addToLog(`<br />${body.message}`);
            });
        };

        // Get AAD Group
        const getAadGroupElement = document.querySelector('#get-aad-group button');
        getAadGroupElement.onclick = async () => {
            const accessToken = document.querySelector('#get-aad-group input#access-token').value;
            const filterDisplayName = document.querySelector('#get-aad-group input#filter-display-name').value;
            validateInputs([
                { value: accessToken, message: '<br />Access token is required to get aad groups...' },
                { value: filterDisplayName, message: '<br />Invalid search display name...' },
            ]);
            if (!accessToken || !filterDisplayName) return;
            const response = await fetch(`${document.location.origin}/aadGroups?filterDisplayName=${encodeURIComponent(filterDisplayName)}`, {
                method: 'GET',
                headers: { Authorization: accessToken }
            })
            response.json().then(({ groupIds }) => console.log({ groupIds }));
        };
    </script>
</html>