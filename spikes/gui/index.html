<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                display: flex;
                height: calc(100vh - 16px);
            }
            input[type="text"] {
                width: 100%;
            }
            .outline {
                margin: 14px;
                padding: 14px;
                border: solid grey 2px;
            }
            #gui, #log {
                height: 100%;
                width: 50vw;
                overflow-y: auto;
            }
            #log {
                height: calc(100% - 30px);
                font-family: Consolas, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New;
                color: white;
                background-color: black;
                padding: 14px;
            }
        </style>
        <title>AD Sync for Databricks</title>
    </head>
    <body>
        <div id="gui">
            <h3>Microsoft Graph API</h3>
            <div id="auth" class="outline">
                <button id="login">Login</button>
                <br /><br />
                <button id="post-access-token">Create Access Token</button>
            </div>
            <div id="refresh" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>Refresh Token: </label><input type="text" id="refresh-token" />
                <br /><br />
                <button id="post-refresh-token">Refresh Token</button>
            </div>
            <div id="post-scim-connector-gallery-app" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM App Template ID: </label><input type="text" id="scim-app-template-id" value="9c9818d2-2900-49e8-8ba4-22688be7c675" />
                <br /><br />
                <label>**SCIM Connector Gallery App Name: </label><input type="text" id="scim-connector-gallery-app-name" />
                <br /><br />
                <button>Create SCIM Connector Gallery App</button>
            </div>
            <div id="get-aad-groups" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>**Search Display Name: </label><input type="text" id="filter-display-name" value="Databricks-SCIM" />
                <br /><br />
                <button>Get AAD Groups</button>
            </div>
            <!--<div id="get-app-role-assignments" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>AAD Groups:</label>
                <div class="aad-group-ids"></div>
                <br />
                <button>Get App Role Assignments</button>
            </div> -->
            <div id="get-service-principals" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <button>Get App Roles via Service Principals</button>
                <br />
                <em>May need to wait until service principals are created for the SCIM Connector Gallery App before getting App Roles</em>
            </div>
            <div id="post-aad-group-to-scim" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>AAD Groups:</label>
                <div id="aad-group-ids"></div>
                <br />
                <label>App Roles:</label>
                <div id="app-role-ids"></div>
                <br />
                <button>Add AAD Group to SCIM</button>
            </div>
            <div id="post-sync-job" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>**Job Template ID: </label><input type="text" id="job-template-id" value="dataBricks" />
                <br /><br />
                <button>Create Sync Job</button>
            </div>
            <div id="post-validate-credentials" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>Sync Job ID: </label><input type="text" class="sync-job-id"/>
                <br /><br />
                <label>**Databricks URL: </label><input type="text" value="https://adb-1514491097879978.18.azuredatabricks.net/api/2.0/preview/scim" class="databricks-url"/>
                <br /><br />
                <label>**Databricks PAT/Secret Token: </label><input type="password" value="default" class="databricks-pat" />
                <br /><br />
                <button>Validate Credentials</button>
            </div>
            <div id="put-save-credentials" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>Sync Job ID: </label><input type="text" class="sync-job-id"/>
                <br /><br />
                <label>**Databricks URL: </label><input type="text" value="https://adb-1514491097879978.18.azuredatabricks.net/api/2.0/preview/scim" class="databricks-url"/>
                <br /><br />
                <label>**Databricks PAT/Secret Token: </label><input type="password" value="default" class="databricks-pat" />
                <br /><br />
                <button>Save Credentials</button>
            </div>
            <div id="post-start-sync-job" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>Sync Job ID: </label><input type="text" class="sync-job-id"/>
                <br /><br />
                <button>Start Sync Job</button>
            </div>
            <div id="get-sync-job-status" class="outline">
                <label>Access Token: </label><span class="token-expiration">0</span> seconds
                <input type="text" class="access-token" />
                <br /><br />
                <label>SCIM Service Principal Object ID: </label><input type="text" class="scim-service-principal-object-id" />
                <br /><br />
                <label>Sync Job ID: </label><input type="text" class="sync-job-id"/>
                <br /><br />
                <button>Monitor Job</button>
            </div>
        </div>
        <div id="log"></div>
    </body>
    <script>
        const logElement = document.getElementById('log');
        function addToLog(content) {
            const childElement = document.createElement('div')
            childElement.innerHTML = content;
            logElement.appendChild(childElement)
            // Scroll Log to the Bottom
            logElement.scrollTop = logElement.scrollHeight - logElement.clientHeight;
        }

        // Get Code Value from URL
        function getCodeValueFromUrl() {
            const codeParam = document.location.search.split('&').filter(param => param.includes('code='))[0];
            return codeParam ? codeParam.split('=')[1] : '';
        }

        // Log: User Login Status
        addToLog(getCodeValueFromUrl() ? 'Logged in...' : 'Not logged in...');

        // Login to Create Code for Access Token
        function redirectToLogin() {
            return window.location.href = document.location.origin + '/login';
        }
        const loginElement = document.querySelector('#auth button#login');
        loginElement.onclick = redirectToLogin;

        // Logs Messages for Missing Values
        function logMissingInputs(inputs) {
            inputs.reduce((time, { value, message }) => {
                if (!value) {
                    setTimeout(() => addToLog(message), time);
                    return time + 800;
                }
                return time;
            }, 800);
        }

        let accessTokenTimer;
        function setAccessTokenTimer(initialExpiration) {
            if (accessTokenTimer) {
                clearInterval(accessTokenTimer);
            }
            // Display token expiration
            const tokenExpirationElements =  document.querySelectorAll('span.token-expiration');
            tokenExpirationElements.forEach(element => element.innerText = initialExpiration);
            // Count down til token expires
            accessTokenTimer = setInterval(() => {
                const tokenExpirationElements =  document.querySelectorAll('span.token-expiration');
                tokenExpirationElements.forEach(element => element.innerText = element.innerText - 1);
            }, 1000)
        }

        // POST for Access Token
        // postAccessToken needs code
        async function postAccessToken() {
            try {
                addToLog('<br />Creating access token...');
                let code = getCodeValueFromUrl();
                if (!code) {
                    return logMissingInputs([{
                        value: code,
                        message: `Login required to get access token...`,
                    }]);
                }
                const response = await fetch(`${document.location.origin}/accessToken?code=${code}`, { method: 'POST' });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 200) {
                    // Display access token
                    const accessTokenElements = document.querySelectorAll('input.access-token');
                    accessTokenElements.forEach(element => element.value = body.access_token);
                    addToLog(`Created access token: ${body.access_token}...`);
                    // Display refresh token
                    const refreshTokenElement = document.querySelector('input#refresh-token');
                    refreshTokenElement.value = body.refresh_token;
                    setAccessTokenTimer(body.expires_in);
                    setTimeout(() => {
                        clearInterval(accessTokenTimer);
                        addToLog('<br />ACCESS TOKEN HAS EXPIRED...');
                    }, body.expires_in * 1000);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error_description);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while fetching access token...');
            }
        }
        document.querySelector('#auth button#post-access-token').onclick = postAccessToken;
        
        async function postRefreshAccessToken() {
            try {
                addToLog('<br />Refreshing access token...');
                let refreshToken = document.querySelector('#refresh input#refresh-token').value;
                if (!refreshToken) {
                    return logMissingInputs([{
                        value: refreshToken,
                        message: `Refresh token required to get access token...`,
                    }]);
                }
                const response = await fetch(`${document.location.origin}/refreshAccessToken`, {
                    method: 'POST',
                    headers: { Authorization: refreshToken }
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 200) {
                    // Display access token
                    const accessTokenElements = document.querySelectorAll('input.access-token');
                    accessTokenElements.forEach(element => element.value = body.access_token);
                    addToLog(`Created access token: ${body.access_token}...`);
                    // Display refresh token
                    const refreshTokenElement = document.querySelector('input#refresh-token');
                    refreshTokenElement.value = body.refresh_token;
                    setAccessTokenTimer(body.expires_in);
                    setTimeout(() => {
                        clearInterval(accessTokenTimer);
                        addToLog('<br />ACCESS TOKEN HAS EXPIRED...');
                    }, body.expires_in * 1000);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error_description);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while fetching access token...');
            }
        }
        document.querySelector('#refresh button#post-refresh-token').onclick = postRefreshAccessToken;
 
        // POST Databricks Gallery App
        // createSCIMApp needs appName and scimAppTemplateId
        // returns scimSPObjId for addGroupToSCIM, createSyncJob, validateCredentials, saveCredentials, startSyncJob, and monitorJob
        async function postScimConnectorGalleryApp() {
            try {
                addToLog('<br/>Creating scim connector gallery app...')
                const accessToken = document.querySelector('#post-scim-connector-gallery-app input.access-token').value;
                const scimAppTemplateId = document.querySelector('#post-scim-connector-gallery-app input#scim-app-template-id').value;
                const scimConnectorGalleryAppName = document.querySelector('#post-scim-connector-gallery-app input#scim-connector-gallery-app-name').value;
                // Validate data required to create SCIM Connector Gallery App
                if (!accessToken || !scimAppTemplateId || !scimConnectorGalleryAppName) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to create scim connector gallery app...' },
                        { value: scimAppTemplateId, message: 'Scim app template id required to create scim connector gallery app...'},
                        { value: scimConnectorGalleryAppName, message: 'Scim connector gallery app name required to create scim connector gallery app...'},
                    ]);
                }
                const response = await fetch(
                    encodeURI(`${document.location.origin}/databricksGalleryApp?scimAppTemplateId=${scimAppTemplateId}&scimConnectorGalleryAppName=${scimConnectorGalleryAppName}`),
                    { method: 'POST', headers: { Authorization: accessToken } },
                );
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 201) {
                    const scimServicePrincipalObjectIdElements = document.querySelectorAll('input.scim-service-principal-object-id');
                    scimServicePrincipalObjectIdElements.forEach(element => element.value = body.scimServicePrincipalObjectId);
                    addToLog(`Created scim connector gallery app: ${scimConnectorGalleryAppName}...`);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.innerError.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while creating scim connector gallery app...');
            }
        };
        const postScimConnectorGalleryAppElement = document.querySelector('#post-scim-connector-gallery-app button');
        postScimConnectorGalleryAppElement.onclick = postScimConnectorGalleryApp;

        // GET AAD Group
        // findAADGroup needs aadGroupName
        // returns groupId for getAppRoleAssignments and addGroupToSCIM
        async function getAadGroups() {
            try {
                addToLog(`<br />Searching for aad groups...`);
                const accessToken = document.querySelector('#get-aad-groups input.access-token').value;
                const filterDisplayName = document.querySelector('#get-aad-groups input#filter-display-name').value;
                if (!accessToken || !filterDisplayName) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to get aad groups...' },
                        { value: filterDisplayName, message: 'Search display name required to get aad groups...' },
                    ]);
                }
                const response = await fetch(`${document.location.origin}/aadGroups?filterDisplayName=${encodeURIComponent(filterDisplayName)}`, {
                    method: 'GET',
                    headers: { Authorization: accessToken }
                })
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 200) {
                    const aadGroupIdsElement = document.querySelector('#aad-group-ids');
                    aadGroupIdsElement.innerHTML = '';
                    addToLog(`Found ${body.length} aad group${body.length === 1 ? '' : 's'}...`);
                    body.forEach(({ aadGroupId, displayName }, index) => {
                        const inputElement = document.createElement('input');
                        if (index === 0) {
                            inputElement.checked = true;
                        }
                        inputElement.type = 'radio';
                        inputElement.id = `aadGroup${index}`;
                        inputElement.name = `aadGroupId`
                        inputElement.value = aadGroupId;
                        const labelElement = document.createElement('label');
                        labelElement.for = `aadGroup${index}`;
                        labelElement.innerText = displayName;
                        aadGroupIdsElement.appendChild(document.createElement('br'));
                        aadGroupIdsElement.appendChild(inputElement);
                        aadGroupIdsElement.appendChild(labelElement);
                        addToLog(`${displayName}: ${aadGroupId}`);
                    });
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while getting aad groups...');
            }
        };
        const getAadGroupsElement = document.querySelector('#get-aad-groups button');
        getAadGroupsElement.onclick = getAadGroups;

        // Using getServicePrincipals to get appRoleId instead
        // GET App Role Assignments
        // getAppRoleAssignments needs groupId
        // returns appRoleId for addGroupToSCIM
        // async function getAppRoleAssignments() {
        //     try {
        //         addToLog(`<br />Fetching app role assignments..`);
        //         const accessToken = document.querySelector('#get-app-role-assignments input.access-token').value;
        //         const checkedAadGroupIdElement =  document.querySelector('#get-app-role-assignments #aad-group-ids>input:checked');
        //         const aadGroupId = checkedAadGroupIdElement && checkedAadGroupIdElement.value;
        //         if (!accessToken || !aadGroupId) {
        //             return logMissingInputs([
        //                 { value: accessToken, message: 'Access token required to get app role assignments...' },
        //                 { value: aadGroupId, message: 'Aad group id required to get app role assignments...' },
        //             ]);
        //         }
        //         const response = await fetch(`${document.location.origin}/appRoleAssignments?aadGroupId=${encodeURIComponent(aadGroupId)}`, {
        //             method: 'GET',
        //             headers: { Authorization: accessToken }
        //         })
        //         const contentType = response.headers.get('content-type');
        //         const body = contentType.includes('json') ? await response.json() : await response.text();
        //         if (response.status === 200) {
        //             // TODO: Need live response values to make accurate
        //             // const appRoleIdElements = document.querySelectorAll('.app-role-id');
        //             // appRoleIdElements.forEach((containerElement, elementIndex) => {
        //             //     containerElement.innerHTML = '';
        //             //     body.forEach((appRoleId, dataIndex) => {
        //             //         const inputElement = document.createElement('input');
        //             //         if (dataIndex === 0) {
        //             //             inputElement.checked = true;
        //             //         }
        //             //         inputElement.type = 'radio';
        //             //         inputElement.id = `appRole${dataIndex}`;
        //             //         inputElement.name = `appRoleId${elementIndex}`
        //             //         inputElement.value = appRoleId;
        //             //         const labelElement = document.createElement('label');
        //             //         labelElement.for = `appRole${dataIndex}`;
        //             //         labelElement.innerText = displayName;
        //             //             containerElement.appendChild(document.createElement('br'));
        //             //             containerElement.appendChild(inputElement);
        //             //             containerElement.appendChild(labelElement);
        //             //     });
        //             // });
        //             addToLog(`Found ${body.length} app role${body.length === 1 ? '' : 's'}...`);
        //             body.forEach((appRoleId) => addToLog(appRoleId));
        //         } else if (response.status === 400 || response.status === 404) {
        //             addToLog(response.statusText + ': ' + body.error.message);
        //         } else if (response.status === 401) {
        //             addToLog(response.statusText + ': ' + body.error.code);
        //         } else {
        //             addToLog(response.statusText + ': ' + body);
        //         }
        //     } catch (err) {
        //         console.error(err);
        //         addToLog('Error while getting app role assignments...');
        //     }
        // }
        // const getAppRoleAssignmentsElement = document.querySelector('#get-app-role-assignments button');
        // getAppRoleAssignmentsElement.onclick = getAppRoleAssignments;

        // GET Service Principals
        // getServicePrincipals needs scimSPObjId
        // returns appRoleId
        async function getServicePrincipals() {
            try {
                addToLog(`<br />Fetching service principals...`);
                const accessToken = document.querySelector('#get-service-principals input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#get-service-principals input.scim-service-principal-object-id').value;
                if(!accessToken || !scimServicePrincipalObjectId) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to get service principals...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to get service principals...' },
                    ]);
                }
                const response = await fetch(`${document.location.origin}/servicePrincipals?scimServicePrincipalObjectId=${encodeURIComponent(scimServicePrincipalObjectId)}`, {
                    method: 'GET',
                    headers: { Authorization: accessToken }
                })
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 200) {
                    const appRoleIdsElement = document.querySelector('#app-role-ids');
                    appRoleIdsElement.innerHTML = '';
                    addToLog(`Found ${body.filter(({ isEnabled }) => isEnabled).length} app role${body.length === 1 ? '' : 's'}...`);
                    body.filter(({ isEnabled }) => isEnabled).forEach(({ displayName, id }, index) => {
                        const inputElement = document.createElement('input');
                        if (index === 0) {
                            inputElement.checked = true;
                        }
                        inputElement.type = 'radio';
                        inputElement.id = `appRole${index}`;
                        inputElement.name = `appRoleId`
                        inputElement.value = id;
                        const labelElement = document.createElement('label');
                        labelElement.for = `appRole${index}`;
                        labelElement.innerText = displayName;
                        appRoleIdsElement.appendChild(document.createElement('br'));
                        appRoleIdsElement.appendChild(inputElement);
                        appRoleIdsElement.appendChild(labelElement);
                        addToLog(`${displayName}: ${id}`);
                    });
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while getting service principals...');
            }
        }
        const getServicePrincipalsElement = document.querySelector('#get-service-principals button');
        getServicePrincipalsElement.onclick = getServicePrincipals;

        // POST Group to SCIM
        // addGroupToSCIM needs scimSPObjId, groupId, and appRoleId
        // returns nothing needed for future requests
        async function postAadGroupToScim() {
            try {
                addToLog(`<br />Adding aad group to scim...`);
                const accessToken = document.querySelector('#post-aad-group-to-scim input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#post-aad-group-to-scim input.scim-service-principal-object-id').value;
                const checkedAadGroupIdElement =  document.querySelector('#post-aad-group-to-scim #aad-group-ids>input:checked');
                const aadGroupId = checkedAadGroupIdElement && checkedAadGroupIdElement.value;
                const checkedAppRoleIdElement =  document.querySelector('#post-aad-group-to-scim #app-role-ids>input:checked');
                const appRoleId = checkedAppRoleIdElement && checkedAppRoleIdElement.value;
                if(!accessToken || !scimServicePrincipalObjectId || !aadGroupId || !appRoleId) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to add aad group to scim...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to add aad group to scim...' },
                        { value: aadGroupId, message: 'Aad group id required to add aad group to scim...'},
                        { value: appRoleId, message: 'App role id required to add aad group to scim...'},
                    ]);
                }
                const parameters = [
                    { key: 'scimServicePrincipalObjectId', value: scimServicePrincipalObjectId },
                    { key: 'aadGroupId', value: aadGroupId },
                    { key: 'appRoleId', value: appRoleId },
                ].map(({ key, value }) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                .join('&');
                const response = await fetch(`${document.location.origin}/aadGroupToScim?${parameters}`, {
                    method: 'POST',
                    headers: { Authorization: accessToken },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 201) {
                    addToLog('Aad group was successfully added to scim...');
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while adding aad group to scim...');
            }
        }
        const postAadGroupToScimElement = document.querySelector('#post-aad-group-to-scim button');
        postAadGroupToScimElement.onclick = postAadGroupToScim;
        
        // POST Sync Job
        // createSyncJob needs scimSPObjId
        // returns jobId for validateCredentials, saveCredentials, startSyncJob, monitorJob
        async function postSyncJob() {
            try {
                addToLog(`<br />Creating sync job...`);
                const accessToken = document.querySelector('#post-sync-job input.access-token').value;
                const jobTemplateId = document.querySelector('#post-sync-job input#job-template-id').value;
                const scimServicePrincipalObjectId = document.querySelector('#post-sync-job input.scim-service-principal-object-id').value;
                if(!accessToken || !jobTemplateId || !scimServicePrincipalObjectId) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to create sync job...' },
                        { value: jobTemplateId, message: 'Job template id required to create sync job...'},
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to create sync job...' },
                    ]);
                }
                const response = await fetch(`${document.location.origin}/createSyncJob?jobTemplateId=${encodeURIComponent(jobTemplateId)}&scimServicePrincipalObjectId=${encodeURIComponent(scimServicePrincipalObjectId)}`, {
                    method: 'POST',
                    headers: { Authorization: accessToken },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 201) {
                    const syncJobIdElements = document.querySelectorAll('input.sync-job-id');
                    syncJobIdElements.forEach(element => element.value = body);
                    addToLog(`Successfully created sync job ${body}...`);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while creating sync job...');
            }
        }
        const postSyncJobElement = document.querySelector('#post-sync-job button');
        postSyncJobElement.onclick = postSyncJob;

        // POST Validate Credentials
        // validateCredentials needs scimSPObjId, jobId(, databricksUrl, and databricksPAT **from User)
        // returns nothing needed for future requests
        async function postValidateCredentials() {
            try {
                addToLog(`<br />Validating credentials...`);
                const accessToken = document.querySelector('#post-validate-credentials input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#post-sync-job input.scim-service-principal-object-id').value;
                const syncJobId = document.querySelector('#post-validate-credentials input.sync-job-id').value;
                const databricksUrl = document.querySelector('#post-validate-credentials input.databricks-url').value;
                const databricksPat = document.querySelector('#post-validate-credentials input.databricks-pat').value;
                if(!accessToken || !scimServicePrincipalObjectId || !syncJobId || !databricksUrl || !databricksPat) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to validate credentials...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to validate credentials...' },
                        { value: syncJobId, message: 'Sync job id required to validate credentials...'},
                        { value: databricksUrl, message: 'Databricks url required to validate credentials...'},
                        { value: databricksPat, message: 'Databricks pat required to validate credentials...'},
                    ]);
                }
                const parameters = [
                    { key: 'scimServicePrincipalObjectId', value: scimServicePrincipalObjectId },
                    { key: 'syncJobId', value: syncJobId },
                    { key: 'databricksUrl', value: databricksUrl },
                ].map(({ key, value }) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                .join('&');
                const response = await fetch(`${document.location.origin}/validateCredentials?${parameters}`, {
                    method: 'POST',
                    headers: { Authorization: accessToken, 'X-Secret-Token': databricksPat },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 204) {
                    addToLog(`Successfully validated credentials...`);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while validating credentials...');
            }
        }
        const postValidateCredentialsElement = document.querySelector('#post-validate-credentials button');
        postValidateCredentialsElement.onclick = postValidateCredentials;

        // PUT Save Credentials
        // saveCredentials needs scimSPObjId, jobId(, databricksUrl, databricksPAT **from User)
        // returns nothing needed for future requests
        async function putSaveCredentials() {
            try {
                addToLog(`<br />Saving credentials...`);
                const accessToken = document.querySelector('#put-save-credentials input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#put-save-credentials input.scim-service-principal-object-id').value;
                const syncJobId = document.querySelector('#put-save-credentials input.sync-job-id').value;
                const databricksUrl = document.querySelector('#put-save-credentials input.databricks-url').value;
                const databricksPat = document.querySelector('#put-save-credentials input.databricks-pat').value;
                if(!accessToken || !scimServicePrincipalObjectId || !syncJobId || !databricksUrl || !databricksPat) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to save credentials...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to save credentials...' },
                        { value: syncJobId, message: 'Sync job id required to save credentials...'},
                        { value: databricksUrl, message: 'Databricks url required to save credentials...'},
                        { value: databricksPat, message: 'Databricks pat required to save credentials...'},
                    ]);
                }
                const parameters = [
                    { key: 'scimServicePrincipalObjectId', value: scimServicePrincipalObjectId },
                    { key: 'syncJobId', value: syncJobId },
                    { key: 'databricksUrl', value: databricksUrl },
                ].map(({ key, value }) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                .join('&');
                const response = await fetch(`${document.location.origin}/saveCredentials?${parameters}`, {
                    method: 'PUT',
                    headers: { Authorization: accessToken, 'X-Secret-Token': databricksPat },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 204) {
                    addToLog(`Successfully saved credentials...`);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while validating credentials...');
            }
        }
        const putSaveCredentialsElement = document.querySelector('#put-save-credentials button');
        putSaveCredentialsElement.onclick = putSaveCredentials;

        // POST Start Sync Job
        // startSyncJob needs scimSPObjId and jobId
        // returns nothing needed for future requests
        async function postStartSyncJob() {
            try {
                addToLog(`<br />Starting sync job...`);
                const accessToken = document.querySelector('#post-start-sync-job input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#post-start-sync-job input.scim-service-principal-object-id').value;
                const syncJobId = document.querySelector('#post-start-sync-job input.sync-job-id').value;
                if(!accessToken || !scimServicePrincipalObjectId || !syncJobId) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to start sync job...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to start sync job...' },
                        { value: syncJobId, message: 'Sync job id required to start sync job...'},
                    ]);
                }
                const response = await fetch(`${document.location.origin}/startSyncJob?scimServicePrincipalObjectId=${encodeURIComponent(scimServicePrincipalObjectId)}&syncJobId=${encodeURIComponent(syncJobId)}`, {
                    method: 'POST',
                    headers: { Authorization: accessToken },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 204) {
                    addToLog(`Successfully started sync job...`);
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while starting sync job...');
            }
        }
        const postStartSyncJobElement = document.querySelector('#post-start-sync-job button');
        postStartSyncJobElement.onclick = postStartSyncJob;
        
        // GET Monitor Job
        // monitorJob needs scimSPObjId and jobId
        // returns logged status
        async function getSyncJobStatus() {
            try {
                addToLog(`<br /> Fetching status of sync job...`);
                const accessToken = document.querySelector('#get-sync-job-status input.access-token').value;
                const scimServicePrincipalObjectId = document.querySelector('#get-sync-job-status input.scim-service-principal-object-id').value;
                const syncJobId = document.querySelector('#get-sync-job-status input.sync-job-id').value;
                if(!accessToken || !scimServicePrincipalObjectId || !syncJobId) {
                    return logMissingInputs([
                        { value: accessToken, message: 'Access token required to get status of sync job...' },
                        { value: scimServicePrincipalObjectId, message: 'Scim service principal object id required to get status of sync job...' },
                        { value: syncJobId, message: 'Sync job id required to get status of sync job...'},
                    ]);
                }
                const response = await fetch(`${document.location.origin}/syncJobStatus?scimServicePrincipalObjectId=${encodeURIComponent(scimServicePrincipalObjectId)}&syncJobId=${encodeURIComponent(syncJobId)}`, {
                    method: 'GET',
                    headers: { Authorization: accessToken },
                });
                const contentType = response.headers.get('content-type');
                const body = contentType.includes('json') ? await response.json() : await response.text();
                if (response.status === 200) {
                    addToLog(`Successfully fetched sync job status...`);
                    const { lastSuccessfulExecution, lastSuccessfulExecutionWithExports, lastExecution } = body;
                    if (!lastSuccessfulExecution && !lastSuccessfulExecutionWithExports && !lastExecution) {
                        addToLog('No available last execution data...');
                    } else {
                        if (lastSuccessfulExecution) {
                            const { state, timeBegan, timeEnded } = lastSuccessfulExecution;
                            addToLog(`Last Successful Execution: {
                                state: ${state},
                                timeBegan: ${timeBegan},
                                timeEnded: ${timeEnded}
                            }`);
                        }
                        if (lastSuccessfulExecutionWithExports) {
                            const { state, timeBegan, timeEnded } = lastSuccessfulExecutionWithExports;
                            addToLog(`Last Successful Execution with Exports: {
                                state: ${state},
                                timeBegan: ${timeBegan},
                                timeEnded: ${timeEnded}
                            }`);
                        }
                        if (lastExecution) {
                            const { state, timeBegan, timeEnded } = lastExecution;
                            addToLog(`Last Execution: {
                                state: ${state},
                                timeBegan: ${timeBegan},
                                timeEnded: ${timeEnded}
                            }`);
                        }
                    }
                } else if (response.status === 400 || response.status === 404) {
                    addToLog(response.statusText + ': ' + body.error.message);
                } else if (response.status === 401) {
                    addToLog(response.statusText + ': ' + body.error.code);
                } else {
                    addToLog(response.statusText + ': ' + body);
                }
            } catch (err) {
                console.error(err);
                addToLog('Error while fetching status of sync job...');
            }
        }
        const getSyncJobStatusElement = document.querySelector('#get-sync-job-status button');
        getSyncJobStatusElement.onclick = getSyncJobStatus;
    </script>
</html>
